{% extends "base.html" %}

{% block title %}Sincroniza√ß√£o CLP{% endblock %}

{% block extra_css %}
<style>
/* Reset e base */
* {
    box-sizing: border-box;
}

/* Container principal */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Cards de status */
.status-card {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}

.status-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.status-card h5 {
    margin: 0 0 15px 0;
    font-size: 1.1em;
    font-weight: 600;
    color: #343a40;
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 8px;
}

/* Indicadores de status */
.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
}

.status-online { 
    background-color: #28a745; 
    box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
}

.status-offline { 
    background-color: #dc3545; 
    box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
}

.status-warning { 
    background-color: #ffc107; 
    box-shadow: 0 0 6px rgba(255, 193, 7, 0.5);
}

/* Bot√µes de sincroniza√ß√£o */
.sync-button {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    margin: 5px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.sync-button:hover:not(:disabled) { 
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

.sync-button:active:not(:disabled) {
    transform: translateY(0);
}

.sync-button:disabled { 
    background: #6c757d; 
    cursor: not-allowed; 
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

/* Container de bot√µes */
.d-flex {
    display: flex;
}

.flex-wrap {
    flex-wrap: wrap;
}

.align-items-center {
    align-items: center;
}

/* Container de log */
.log-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    max-height: 300px;
    overflow-y: auto;
    line-height: 1.4;
}

.log-container::-webkit-scrollbar {
    width: 8px;
}

.log-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.log-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Barra de progresso */
.progress-bar {
    width: 100%;
    height: 24px;
    background: #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.4s ease;
    border-radius: 12px;
}

/* Timestamps e textos pequenos */
.timestamp {
    color: #6c757d;
    font-size: 0.85em;
    margin-top: 5px;
}

/* Mensagens de erro e sucesso */
.error-message {
    color: #721c24;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #dc3545;
}

.success-message {
    color: #155724;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 12px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #28a745;
}

/* Grid responsivo */
.row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
}

.col-12 {
    flex: 0 0 100%;
    max-width: 100%;
    padding: 0 15px;
}

.col-md-4 {
    flex: 0 0 33.333333%;
    max-width: 33.333333%;
    padding: 0 15px;
}

.col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
    padding: 0 15px;
}

/* Inputs do formul√°rio */
.form-control {
    display: inline-block;
    padding: 6px 12px;
    font-size: 14px;
    line-height: 1.42857143;
    color: #555;
    background-color: #fff;
    background-image: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
    transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
}

.form-control:focus {
    border-color: #007bff;
    outline: 0;
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* Bot√µes do Bootstrap */
.btn {
    display: inline-block;
    font-weight: 400;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    user-select: none;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    cursor: pointer;
    text-decoration: none;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

.btn-primary {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    color: #fff;
    background-color: #0069d9;
    border-color: #0062cc;
}

.btn-secondary {
    color: #fff;
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover {
    color: #fff;
    background-color: #5a6268;
    border-color: #545b62;
}

/* Responsividade */
@media (max-width: 768px) {
    .col-md-4, .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .sync-button {
        width: 100%;
        margin: 3px 0;
        justify-content: center;
    }
    
    .d-flex {
        flex-direction: column;
    }
    
    .form-control[style*="display:inline"] {
        display: block !important;
        width: 100% !important;
        margin: 5px 0 !important;
    }
}

/* Utilit√°rios */
.mt-2 { margin-top: 0.5rem; }
.mb-2 { margin-bottom: 0.5rem; }
.float-right { float: right; }
.text-muted { color: #6c757d; }

/* Animations */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.status-card.syncing {
    animation: pulse 2s infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1>Sincroniza√ß√£o CLP</h1>
            <p class="text-muted">Monitoramento e controle da sincroniza√ß√£o com Controladores L√≥gicos Program√°veis</p>
        </div>
    </div>

    <!-- Status Geral -->
    <div class="row">
        <div class="col-md-4">
            <div class="status-card">
                <h5>Status da Conex√£o</h5>
                <div id="connection-status">
                    <span class="status-indicator status-offline" id="connection-indicator"></span>
                    <span id="connection-text">Verificando...</span>
                </div>
                <div class="timestamp" id="connection-timestamp"></div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="status-card">
                <h5>√öltima Sincroniza√ß√£o</h5>
                <div id="last-sync">
                    <span id="last-sync-text">Nunca sincronizado</span>
                </div>
                <div class="timestamp" id="last-sync-timestamp"></div>
                <div><small id="sync-details">-</small></div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="status-card">
                <h5>Pr√≥xima Sincroniza√ß√£o</h5>
                <div id="next-sync">
                    <span id="next-sync-text">-</span>
                </div>
                <div><small>Autom√°tica: <span id="auto-sync-status">-</span></small></div>
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="row">
        <div class="col-12">
            <div class="status-card">
                <h5>Controles Gerais</h5>
                <div class="d-flex flex-wrap align-items-center">
                    <button class="sync-button" onclick="executarSincronizacao()" id="btn-sincronizar">
                        Sincronizar Tudo
                    </button>
                    <button class="sync-button" onclick="verificarConectividade()" id="btn-conectividade">
                        Testar Conex√£o
                    </button>

                    <button class="sync-button" onclick="atualizarStatus()" id="btn-atualizar">
                        Atualizar Status
                    </button>
                    <button class="sync-button" onclick="limparTodosDados()" id="btn-limpar-tudo" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                        Limpar Tudo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√µes Separadas -->
    <div class="row">
        <!-- Se√ß√£o Feriados -->
        <div class="col-md-4">
            <div class="status-card">
                <h5>üìÖ Feriados (CLP T√©rreo B1)</h5>
                <div id="feriados-info">
                    <p><strong>Slots utilizados:</strong> <span id="feriados-slots">0/20</span></p>
                    <p><strong>Tags:</strong> N33 (dia), N34 (m√™s)</p>
                    <p><strong>√öltimo envio:</strong> <span id="feriados-ultimo">-</span></p>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                    <button class="sync-button" onclick="limparFeriados()" id="btn-limpar-feriados" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                        Limpar Feriados
                    </button>
                </div>
                <div id="feriados-dados" class="mt-3" style="display: none;">
                    <small><strong>Dados enviados para o CLP:</strong></small>
                    <div id="feriados-lista" class="log-container" style="max-height: 200px;"></div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o Eventos Plen√°rio -->
        <div class="col-md-4">
            <div class="status-card">
                <h5>üèõÔ∏è Eventos Plen√°rio (CLP T√©rreo B1)</h5>
                <div id="eventos-info">
                    <p><strong>Slots utilizados:</strong> <span id="eventos-slots">0/10</span></p>
                    <p><strong>Tags:</strong> N60-N65 (6 tags por evento)</p>
                    <p><strong>√öltimo envio:</strong> <span id="eventos-ultimo">-</span></p>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                    <button class="sync-button" onclick="limparEventosPlenario()" id="btn-limpar-eventos" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                        Limpar Eventos
                    </button>
                </div>
                <div id="eventos-dados" class="mt-3" style="display: none;">
                    <small><strong>Dados enviados para o CLP:</strong></small>
                    <div id="eventos-lista" class="log-container" style="max-height: 200px;"></div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o Eventos Audit√≥rio -->
        <div class="col-md-4">
            <div class="status-card">
                <h5>üé≠ Eventos Audit√≥rio (CLP AR)</h5>
                <div id="eventos-auditorio-info">
                    <p><strong>Slots utilizados:</strong> <span id="eventos-auditorio-slots">0/10</span></p>
                    <p><strong>Tags:</strong> N91-N96 (6 tags por evento)</p>
                    <p><strong>√öltimo envio:</strong> <span id="eventos-auditorio-ultimo">-</span></p>
                    <p><strong>Locais:</strong> Audit√≥rio Nobre, Foyer</p>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                    <button class="sync-button" onclick="limparEventosAuditorio()" id="btn-limpar-eventos-auditorio" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                        Limpar Eventos
                    </button>
                    <button class="sync-button" onclick="sincronizarAuditorio()" id="btn-sync-auditorio" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                        Sincronizar
                    </button>
                </div>
                <div id="eventos-auditorio-dados" class="mt-3" style="display: none;">
                    <small><strong>Dados enviados para o CLP:</strong></small>
                    <div id="eventos-auditorio-lista" class="log-container" style="max-height: 200px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status dos CLPs -->
    <div class="row">
        <div class="col-md-6">
            <div class="status-card">
                <h5>Status CLP T√©rreo B1 (172.17.85.104)</h5>
                <div id="status-plenario">
                    <div><strong>Conex√£o:</strong> <span id="plenario-conexao">Verificando...</span></div>
                    <div><strong>√öltima Sincroniza√ß√£o:</strong> <span id="plenario-sync">-</span></div>
                    <div><strong>Pr√≥xima Autom√°tica:</strong> <span id="plenario-proxima">-</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="status-card">
                <h5>Status CLP Audit√≥rio AR (172.17.85.123)</h5>
                <div id="status-auditorio">
                    <div><strong>Conex√£o:</strong> <span id="auditorio-conexao">Verificando...</span></div>
                    <div><strong>√öltima Sincroniza√ß√£o:</strong> <span id="auditorio-sync">-</span></div>
                    <div><strong>Pr√≥xima Autom√°tica:</strong> <span id="auditorio-proxima">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progresso da Sincroniza√ß√£o -->
    <div class="row" id="progress-section" style="display: none;">
        <div class="col-12">
            <div class="status-card">
                <h5>Progresso da Sincroniza√ß√£o</h5>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="mt-2">
                    <span id="progress-text">Preparando...</span>
                    <span class="float-right" id="progress-percent">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Dados Detalhados -->
    <div class="row">
        <div class="col-md-6">
            <div class="status-card">
                <h5>Dados do Sistema</h5>
                <div id="system-data">
                    <div>Feriados (ano atual): <span id="system-feriados">-</span></div>
                    <div>Eventos (ano atual): <span id="system-eventos">-</span></div>
                    <div>√öltima atualiza√ß√£o: <span id="system-timestamp">-</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="status-card">
                <h5>Status de Sincroniza√ß√£o</h5>
                <div id="sync-data">
                    <div>Feriados sincronizados: <span id="sync-feriados">-</span></div>
                    <div>Eventos sincronizados: <span id="sync-eventos">-</span></div>
                    <div>√öltima sincroniza√ß√£o: <span id="sync-timestamp">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log de Atividades -->
    <div class="row">
        <div class="col-12">
            <div class="status-card">
                <h5>Log de Atividades</h5>
                <div class="log-container" id="log-container">
                    <div>Aguardando atividades...</div>
                </div>
                <button class="btn btn-sm btn-secondary mt-2" onclick="limparLog()">Limpar Log</button>
            </div>
        </div>
    </div>

    <!-- Mensagens -->
    <div id="messages"></div>

    <!-- Teste de Tags -->
    <div class="row">
        <div class="col-md-6">
            <div class="status-card">
                <h5>Teste Manual de Tags</h5>
                <div class="mb-2">
                    <label>Tag:</label>
                    <input type="text" id="input-tag" value="N33:0" class="form-control" style="display:inline; width:100px; margin:0 10px;">
                    <label>Valor:</label>
                    <input type="number" id="input-valor" placeholder="Deixe vazio para ler" class="form-control" style="display:inline; width:120px; margin:0 10px;">
                    <button class="btn btn-sm btn-primary" onclick="testarTagCustom()">Executar</button>
                </div>
                <div id="resultado-teste" style="margin-top:10px; font-family:monospace; background:#f8f9fa; padding:10px; border-radius:5px;">
                    Resultado aparecer√° aqui...
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="status-card">
                <h5>Mapeamento TCE - Feriados</h5>
                <div style="font-family: monospace; font-size: 0.9em;">
                    <div><strong>N33:0-19</strong> - Dias dos feriados</div>
                    <div><strong>N34:0-19</strong> - Meses dos feriados</div>
                    <div><strong>CLP IP:</strong> 172.17.85.104</div>
                    <div><strong>Slots dispon√≠veis:</strong> 20 feriados</div>
                    <div style="margin-top:10px;">
                        <small><strong>Exemplo:</strong><br>
                        N33:0 = 25, N34:0 = 12 ‚Üí Natal (25/12)<br>
                        N33:1 = 1, N34:1 = 1 ‚Üí Ano Novo (01/01)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts JavaScript -->
<script>
let logCount = 0;
let syncInProgress = false;

// Fun√ß√£o para adicionar log
function adicionarLog(mensagem, tipo = 'info') {
    const logContainer = document.getElementById('log-container');
    const timestamp = new Date().toLocaleString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `[${timestamp}] ${mensagem}`;
    
    if (tipo === 'error') logEntry.style.color = '#dc3545';
    if (tipo === 'success') logEntry.style.color = '#28a745';
    if (tipo === 'warning') logEntry.style.color = '#ffc107';
    
    if (logCount === 0) {
        logContainer.innerHTML = '';
    }
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    logCount++;
}

// Fun√ß√£o para mostrar mensagem
function mostrarMensagem(mensagem, tipo = 'info') {
    const messagesDiv = document.getElementById('messages');
    const messageClass = tipo === 'error' ? 'error-message' : 'success-message';
    
    messagesDiv.innerHTML = `<div class="${messageClass}">${mensagem}</div>`;
    
    setTimeout(() => {
        messagesDiv.innerHTML = '';
    }, 5000);
}

// Fun√ß√£o para atualizar indicador de status
function atualizarIndicadorStatus(elementId, status) {
    const indicator = document.getElementById(elementId);
    indicator.className = 'status-indicator';
    
    if (status === 'online' || status === true) {
        indicator.classList.add('status-online');
    } else if (status === 'warning') {
        indicator.classList.add('status-warning');
    } else {
        indicator.classList.add('status-offline');
    }
}

// Fun√ß√£o para mostrar progresso
function mostrarProgresso(show, texto = '', porcentagem = 0) {
    const progressSection = document.getElementById('progress-section');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');
    const progressFill = document.getElementById('progress-fill');
    
    if (show) {
        progressSection.style.display = 'block';
        progressText.textContent = texto;
        progressPercent.textContent = `${porcentagem}%`;
        progressFill.style.width = `${porcentagem}%`;
    } else {
        progressSection.style.display = 'none';
    }
}

// Fun√ß√£o para executar sincroniza√ß√£o
async function executarSincronizacao() {
    if (syncInProgress) return;
    
    syncInProgress = true;
    document.getElementById('btn-sincronizar').disabled = true;
    
    adicionarLog('Iniciando sincroniza√ß√£o manual...', 'info');
    mostrarProgresso(true, 'Conectando ao CLP...', 10);
    
    try {
        const response = await fetch('{{ url_for("api_clp.executar_sincronizacao") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            mostrarProgresso(true, 'Sincroniza√ß√£o conclu√≠da!', 100);
            adicionarLog(`Sincroniza√ß√£o conclu√≠da: ${resultado.dados_sincronizados} itens (${resultado.feriados} feriados, ${resultado.eventos_plenario} eventos)`, 'success');
            mostrarMensagem('Sincroniza√ß√£o realizada com sucesso!', 'success');
            
            setTimeout(() => {
                mostrarProgresso(false);
                atualizarStatus();
            }, 2000);
        } else {
            mostrarProgresso(false);
            adicionarLog(`Erro na sincroniza√ß√£o: ${resultado.erro}`, 'error');
            mostrarMensagem(`Erro na sincroniza√ß√£o: ${resultado.erro}`, 'error');
            
            if (resultado.erros && resultado.erros.length > 0) {
                resultado.erros.forEach(erro => adicionarLog(`- ${erro}`, 'error'));
            }
        }
    } catch (error) {
        mostrarProgresso(false);
        adicionarLog(`Erro de conex√£o: ${error.message}`, 'error');
        mostrarMensagem('Erro de conex√£o com o servidor', 'error');
    } finally {
        syncInProgress = false;
        document.getElementById('btn-sincronizar').disabled = false;
    }
}

// Fun√ß√£o para verificar conectividade
async function verificarConectividade() {
    adicionarLog('Verificando conectividade com CLP...', 'info');
    
    try {
        const response = await fetch('{{ url_for("api_clp.verificar_conectividade") }}');
        const resultado = await response.json();
        
        if (resultado.conectado) {
            adicionarLog('CLP conectado e acess√≠vel', 'success');
            mostrarMensagem('CLP conectado com sucesso!', 'success');
        } else {
            adicionarLog(`CLP n√£o acess√≠vel: ${resultado.mensagem}`, 'error');
            mostrarMensagem(`CLP n√£o acess√≠vel: ${resultado.mensagem}`, 'error');
        }
        
        atualizarIndicadorStatus('connection-indicator', resultado.conectado);
        document.getElementById('connection-text').textContent = resultado.mensagem;
        document.getElementById('connection-timestamp').textContent = new Date(resultado.timestamp).toLocaleString();
        
    } catch (error) {
        adicionarLog(`Erro ao verificar conectividade: ${error.message}`, 'error');
        mostrarMensagem('Erro ao verificar conectividade', 'error');
    }
}


// Fun√ß√£o para atualizar status geral
async function atualizarStatus() {
    try {
        console.log('[DEBUG] Iniciando atualizarStatus()');
        
        // Status de sincroniza√ß√£o
        const syncUrl = '{{ url_for("api_clp.status_sincronizacao") }}';
        console.log('[DEBUG] Fazendo fetch para:', syncUrl);
        
        const syncResponse = await fetch(syncUrl);
        console.log('[DEBUG] Response status:', syncResponse.status);
        
        const syncStatus = await syncResponse.json();
        console.log('[DEBUG] syncStatus recebido:', syncStatus);
        
        // Atualizar dados na interface
        if (syncStatus.ultima_sincronizacao) {
            document.getElementById('last-sync-text').textContent = 'Sincronizado';
            document.getElementById('last-sync-timestamp').textContent = new Date(syncStatus.ultima_sincronizacao).toLocaleString();
            
            const feriados = syncStatus.feriados_sincronizados || 0;
            const eventos = syncStatus.eventos_sincronizados || 0;
            document.getElementById('sync-details').textContent = `${feriados} feriados, ${eventos} eventos Plen√°rio`;
            
            // Atualizar contadores
            document.getElementById('feriados-slots').textContent = `${feriados}/20`;
            document.getElementById('eventos-slots').textContent = `${eventos}/10`;
            
            // Atualizar dados de sincroniza√ß√£o
            document.getElementById('sync-feriados').textContent = feriados;
            document.getElementById('sync-eventos').textContent = eventos;
            document.getElementById('sync-timestamp').textContent = new Date(syncStatus.ultima_sincronizacao).toLocaleString();
        }
        
        // Status da conex√£o
        console.log('[DEBUG] Atualizando indicador de status. clp_online:', syncStatus.clp_online);
        atualizarIndicadorStatus('connection-indicator', syncStatus.clp_online);
        document.getElementById('connection-text').textContent = syncStatus.msg_conectividade;
        
        // Atualizar status espec√≠fico do CLP T√©rreo B1
        console.log('[DEBUG] Atualizando status espec√≠fico do CLP T√©rreo B1');
        const plenarioConexaoElement = document.getElementById('plenario-conexao');
        if (plenarioConexaoElement) {
            plenarioConexaoElement.textContent = syncStatus.clp_online ? 'Online' : 'Offline';
            plenarioConexaoElement.style.color = syncStatus.clp_online ? '#28a745' : '#dc3545';
            console.log('[DEBUG] plenario-conexao atualizado para:', plenarioConexaoElement.textContent);
        } else {
            console.error('[ERROR] Elemento plenario-conexao n√£o encontrado!');
        }
        
        const plenarioSyncElement = document.getElementById('plenario-sync');
        if (plenarioSyncElement) {
            if (syncStatus.ultima_sincronizacao) {
                plenarioSyncElement.textContent = new Date(syncStatus.ultima_sincronizacao).toLocaleString();
                console.log('[DEBUG] plenario-sync atualizado para:', plenarioSyncElement.textContent);
            } else {
                plenarioSyncElement.textContent = 'Nunca sincronizado';
                console.log('[DEBUG] plenario-sync: nunca sincronizado');
            }
        } else {
            console.error('[ERROR] Elemento plenario-sync n√£o encontrado!');
        }
        
        const plenarioProximaElement = document.getElementById('plenario-proxima');
        if (plenarioProximaElement) {
            if (syncStatus.sync_automatica_habilitada && syncStatus.horarios_sincronizacao) {
                plenarioProximaElement.textContent = `Autom√°tica (${syncStatus.horarios_sincronizacao.join(', ')})`;
            } else {
                plenarioProximaElement.textContent = 'Desabilitada';
            }
            console.log('[DEBUG] plenario-proxima atualizado para:', plenarioProximaElement.textContent);
        } else {
            console.error('[ERROR] Elemento plenario-proxima n√£o encontrado!');
        }
        
        // Pr√≥xima sincroniza√ß√£o
        if (syncStatus.sync_automatica_habilitada) {
            document.getElementById('next-sync-text').textContent = 'Autom√°tica habilitada';
            document.getElementById('auto-sync-status').textContent = `Hor√°rios: ${syncStatus.horarios_sincronizacao.join(', ')}`;
        } else {
            document.getElementById('next-sync-text').textContent = 'Desabilitada';
            document.getElementById('auto-sync-status').textContent = 'Sincroniza√ß√£o autom√°tica desabilitada';
        }
        
        // Obter dados do sistema atual
        const eventosResponse = await fetch('{{ url_for("api_eventos.listar_eventos") }}?ano=' + new Date().getFullYear());
        const eventosData = await eventosResponse.json();
        
        const feriadosResponse = await fetch('{{ url_for("api_feriados.listar_feriados") }}?ano=' + new Date().getFullYear());
        const feriadosData = await feriadosResponse.json();
        
        document.getElementById('system-feriados').textContent = feriadosData.total || 0;
        document.getElementById('system-eventos').textContent = eventosData.total || 0;
        document.getElementById('system-timestamp').textContent = new Date().toLocaleString();
        
        // Atualizar informa√ß√µes espec√≠ficas do TCE
        if (syncStatus.feriados_sincronizados !== undefined) {
            document.getElementById('sync-details').textContent = `${syncStatus.feriados_sincronizados} feriados sincronizados (slots: ${syncStatus.feriados_sincronizados}/20)`;
        }
        
        console.log('[DEBUG] atualizarStatus() conclu√≠do com sucesso');
        
    } catch (error) {
        console.error('[ERROR] Erro ao atualizar status:', error);
        adicionarLog(`Erro ao atualizar status: ${error.message}`, 'error');
    }
}

// Fun√ß√£o para limpar log
function limparLog() {
    document.getElementById('log-container').innerHTML = '<div>Log limpo...</div>';
    logCount = 0;
}

// Fun√ß√£o para testar tag customizada
async function testarTagCustom() {
    const tag = document.getElementById('input-tag').value;
    const valorInput = document.getElementById('input-valor').value;
    const valor = valorInput ? parseInt(valorInput) : null;
    
    const resultadoDiv = document.getElementById('resultado-teste');
    
    try {
        let url = `{{ url_for("api_clp.teste_tag") }}?tag=${encodeURIComponent(tag)}`;
        if (valor !== null) {
            url += `&valor=${valor}`;
        }
        
        const response = await fetch(url);
        const resultado = await response.json();
        
        if (response.ok) {
            let html = `<strong>${resultado.operacao.toUpperCase()}:</strong> ${tag}<br>`;
            
            if (resultado.operacao === 'escrita') {
                html += `Valor escrito: ${resultado.valor_escrito}<br>`;
                html += `Sucesso: ${resultado.sucesso ? 'SIM' : 'N√ÉO'}<br>`;
            } else {
                html += `Valor lido: ${resultado.valor_lido}<br>`;
            }
            
            html += `<small>Resposta CLP: ${JSON.stringify(resultado.resposta_clp)}</small>`;
            resultadoDiv.innerHTML = html;
            resultadoDiv.style.color = '#28a745';
            
            adicionarLog(`${resultado.operacao} ${tag} = ${resultado.valor_escrito || resultado.valor_lido}`, 'success');
            
        } else {
            resultadoDiv.innerHTML = `<strong>ERRO:</strong> ${resultado.erro}`;
            resultadoDiv.style.color = '#dc3545';
            adicionarLog(`Erro no teste de ${tag}: ${resultado.erro}`, 'error');
        }
        
    } catch (error) {
        resultadoDiv.innerHTML = `<strong>ERRO:</strong> ${error.message}`;
        resultadoDiv.style.color = '#dc3545';
        adicionarLog(`Erro no teste customizado: ${error.message}`, 'error');
    }
}

// Fun√ß√£o para limpar todos os feriados do CLP
async function limparFeriados() {
    if (!confirm('Tem certeza que deseja limpar TODOS os feriados do CLP? Esta a√ß√£o ir√° zerar as tags N33 e N34.')) {
        return;
    }
    
    adicionarLog('Iniciando limpeza de feriados no CLP...', 'info');
    mostrarProgresso(true, 'Limpando slots de feriados...', 0);
    
    try {
        const response = await fetch('{{ url_for("api_clp.limpar_feriados") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            mostrarProgresso(true, 'Limpeza conclu√≠da!', 100);
            adicionarLog(`Limpeza conclu√≠da: ${resultado.slots_limpos}/${resultado.total_slots} slots limpos`, 'success');
            mostrarMensagem(`Feriados limpos com sucesso! ${resultado.slots_limpos} slots zerados.`, 'success');
            
            // Atualizar display de feriados
            document.getElementById('feriados-slots').textContent = '0/20';
            document.getElementById('feriados-dados').style.display = 'none';
            
            setTimeout(() => {
                mostrarProgresso(false);
            }, 2000);
        } else {
            mostrarProgresso(false);
            adicionarLog(`Limpeza com problemas: ${resultado.slots_limpos}/${resultado.total_slots} slots limpos`, 'warning');
            
            if (resultado.erros && resultado.erros.length > 0) {
                resultado.erros.forEach(erro => adicionarLog(`- ${erro}`, 'error'));
            }
            
            mostrarMensagem(`Limpeza parcial: ${resultado.slots_limpos}/${resultado.total_slots} slots limpos`, 'warning');
        }
        
    } catch (error) {
        mostrarProgresso(false);
        adicionarLog(`Erro na limpeza: ${error.message}`, 'error');
        mostrarMensagem('Erro na limpeza de feriados', 'error');
    }
}





// Fun√ß√£o para limpar eventos do Audit√≥rio
async function limparEventosAuditorio() {
    if (!confirm('Tem certeza que deseja limpar todos os eventos do Audit√≥rio no CLP?')) {
        return;
    }
    
    adicionarLog('Limpando eventos do Audit√≥rio no CLP...', 'info');
    
    try {
        const response = await fetch('{{ url_for("api_clp_auditorio.limpar_eventos_auditorio") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            const slotsLimpos = resultado.slots_limpos || 0;
            const totalSlots = resultado.total_slots || 10;
            
            adicionarLog(`Eventos do Audit√≥rio limpos: ${slotsLimpos}/${totalSlots} slots`, 'success');
            mostrarMensagem(`Eventos do Audit√≥rio limpos com sucesso! ${slotsLimpos} slots zerados.`, 'success');
            
            // Atualizar display
            document.getElementById('eventos-auditorio-slots').textContent = '0/10';
            document.getElementById('eventos-auditorio-dados').style.display = 'none';
            
            atualizarStatusAuditorio();
        } else {
            const erro = resultado.erro || resultado.error || 'Erro desconhecido';
            adicionarLog(`Erro ao limpar eventos do Audit√≥rio: ${erro}`, 'error');
            mostrarMensagem(`Erro ao limpar eventos do Audit√≥rio: ${erro}`, 'error');
        }
    } catch (error) {
        adicionarLog(`Erro ao limpar eventos do Audit√≥rio: ${error.message}`, 'error');
        mostrarMensagem('Erro ao limpar eventos do Audit√≥rio', 'error');
    }
}

// Fun√ß√£o para sincronizar apenas o CLP Audit√≥rio
async function sincronizarAuditorio() {
    if (syncInProgress) return;
    
    syncInProgress = true;
    document.getElementById('btn-sync-auditorio').disabled = true;
    
    adicionarLog('Iniciando sincroniza√ß√£o do CLP Audit√≥rio...', 'info');
    
    try {
        const response = await fetch('{{ url_for("api_clp_auditorio.executar_sincronizacao_auditorio") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            const dadosSincronizados = resultado.dados_sincronizados || 0;
            adicionarLog(`Sincroniza√ß√£o do Audit√≥rio conclu√≠da: ${dadosSincronizados} eventos`, 'success');
            mostrarMensagem('Sincroniza√ß√£o do Audit√≥rio realizada com sucesso!', 'success');
            
            // Atualizar display
            document.getElementById('eventos-auditorio-slots').textContent = `${dadosSincronizados}/10`;
            
            atualizarStatusAuditorio();
        } else {
            const erro = resultado.erro || resultado.error || 'Erro desconhecido';
            adicionarLog(`Erro na sincroniza√ß√£o do Audit√≥rio: ${erro}`, 'error');
            mostrarMensagem(`Erro na sincroniza√ß√£o do Audit√≥rio: ${erro}`, 'error');
        }
    } catch (error) {
        adicionarLog(`Erro de conex√£o com CLP Audit√≥rio: ${error.message}`, 'error');
        mostrarMensagem('Erro de conex√£o com CLP Audit√≥rio', 'error');
    } finally {
        syncInProgress = false;
        document.getElementById('btn-sync-auditorio').disabled = false;
    }
}

// Fun√ß√£o para atualizar status espec√≠fico do CLP Audit√≥rio
async function atualizarStatusAuditorio() {
    try {
        console.log('[DEBUG] Iniciando atualizarStatusAuditorio()');
        
        // Status de conectividade
        const conectUrl = '{{ url_for("api_clp_auditorio.verificar_conectividade_auditorio") }}';
        console.log('[DEBUG] Fazendo fetch conectividade audit√≥rio para:', conectUrl);
        
        const conectResponse = await fetch(conectUrl);
        console.log('[DEBUG] Conectividade audit√≥rio response status:', conectResponse.status);
        
        const conectData = await conectResponse.json();
        console.log('[DEBUG] Conectividade audit√≥rio data:', conectData);
        
        const auditorioConexaoElement = document.getElementById('auditorio-conexao');
        if (auditorioConexaoElement) {
            auditorioConexaoElement.textContent = conectData.conectado ? 'Online' : 'Offline';
            auditorioConexaoElement.style.color = conectData.conectado ? '#28a745' : '#dc3545';
            console.log('[DEBUG] auditorio-conexao atualizado para:', auditorioConexaoElement.textContent);
        } else {
            console.error('[ERROR] Elemento auditorio-conexao n√£o encontrado!');
        }
        
        // Status de sincroniza√ß√£o
        const statusUrl = '{{ url_for("api_clp_auditorio.obter_status_auditorio") }}';
        console.log('[DEBUG] Fazendo fetch status audit√≥rio para:', statusUrl);
        
        const statusResponse = await fetch(statusUrl);
        console.log('[DEBUG] Status audit√≥rio response status:', statusResponse.status);
        
        const statusData = await statusResponse.json();
        console.log('[DEBUG] Status audit√≥rio data:', statusData);
        
        const auditorioSyncElement = document.getElementById('auditorio-sync');
        const eventosAuditorioUltimoElement = document.getElementById('eventos-auditorio-ultimo');
        
        if (statusData.ultima_sincronizacao) {
            const dataFormatada = new Date(statusData.ultima_sincronizacao).toLocaleString();
            if (auditorioSyncElement) {
                auditorioSyncElement.textContent = dataFormatada;
                console.log('[DEBUG] auditorio-sync atualizado para:', dataFormatada);
            }
            if (eventosAuditorioUltimoElement) {
                eventosAuditorioUltimoElement.textContent = dataFormatada;
                console.log('[DEBUG] eventos-auditorio-ultimo atualizado para:', dataFormatada);
            }
            
            const eventosSincronizados = statusData.eventos_sincronizados || 0;
            const eventosAuditorioSlotsElement = document.getElementById('eventos-auditorio-slots');
            if (eventosAuditorioSlotsElement) {
                eventosAuditorioSlotsElement.textContent = `${eventosSincronizados}/10`;
                console.log('[DEBUG] eventos-auditorio-slots atualizado para:', `${eventosSincronizados}/10`);
            }
        } else {
            if (auditorioSyncElement) {
                auditorioSyncElement.textContent = 'Nunca sincronizado';
                console.log('[DEBUG] auditorio-sync: nunca sincronizado');
            }
            if (eventosAuditorioUltimoElement) {
                eventosAuditorioUltimoElement.textContent = '-';
                console.log('[DEBUG] eventos-auditorio-ultimo: nunca sincronizado');
            }
            const eventosAuditorioSlotsElement = document.getElementById('eventos-auditorio-slots');
            if (eventosAuditorioSlotsElement) {
                eventosAuditorioSlotsElement.textContent = '0/10';
                console.log('[DEBUG] eventos-auditorio-slots: 0/10');
            }
        }
        
        // Pr√≥xima sincroniza√ß√£o
        const auditorioProximaElement = document.getElementById('auditorio-proxima');
        if (auditorioProximaElement) {
            if (statusData.sync_automatica_habilitada && statusData.horarios_sincronizacao) {
                auditorioProximaElement.textContent = `Autom√°tica (${statusData.horarios_sincronizacao.join(', ')})`;
            } else {
                auditorioProximaElement.textContent = 'Desabilitada';
            }
            console.log('[DEBUG] auditorio-proxima atualizado para:', auditorioProximaElement.textContent);
        } else {
            console.error('[ERROR] Elemento auditorio-proxima n√£o encontrado!');
        }
        
        console.log('[DEBUG] atualizarStatusAuditorio() conclu√≠do com sucesso');
        
    } catch (error) {
        console.error('[ERROR] Erro ao atualizar status do Audit√≥rio:', error);
        const auditorioConexaoElement = document.getElementById('auditorio-conexao');
        if (auditorioConexaoElement) {
            auditorioConexaoElement.textContent = 'Erro';
            auditorioConexaoElement.style.color = '#dc3545';
        }
    }
}

// Fun√ß√£o para limpar eventos do Plen√°rio (utilizando a limpeza geral por enquanto)
async function limparEventosPlenario() {
    if (!confirm('Tem certeza que deseja limpar todos os eventos do Plen√°rio no CLP?')) {
        return;
    }
    
    adicionarLog('Limpando eventos do Plen√°rio no CLP...', 'info');
    
    try {
        // Por enquanto usa a limpeza completa pois n√£o temos endpoint espec√≠fico para eventos
        const response = await fetch('{{ url_for("api_clp.limpar_dados_completo") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            adicionarLog('Todos os dados (incluindo eventos) limpos no CLP', 'success');
            mostrarMensagem('Dados limpos com sucesso! (Nota: todos os dados foram limpos)', 'success');
            
            // Atualizar displays
            document.getElementById('eventos-slots').textContent = '0/10';
            document.getElementById('feriados-slots').textContent = '0/20';
            document.getElementById('eventos-dados').style.display = 'none';
            document.getElementById('feriados-dados').style.display = 'none';
        } else {
            adicionarLog(`Erro ao limpar dados: ${resultado.erro}`, 'error');
            mostrarMensagem(`Erro ao limpar dados: ${resultado.erro}`, 'error');
        }
    } catch (error) {
        adicionarLog(`Erro ao limpar eventos: ${error.message}`, 'error');
        mostrarMensagem('Erro ao limpar eventos', 'error');
    }
}

// Fun√ß√£o para limpeza completa (todos os dados)
async function limparTodosDados() {
    if (!confirm('ATEN√á√ÉO: Isso ir√° limpar TODOS os dados (feriados e eventos) no CLP. Tem certeza?')) {
        return;
    }
    
    adicionarLog('Limpando todos os dados no CLP...', 'info');
    
    try {
        const response = await fetch('{{ url_for("api_clp.limpar_dados_completo") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const resultado = await response.json();
        
        if (resultado.sucesso) {
            adicionarLog('Todos os dados limpos no CLP com sucesso', 'success');
            mostrarMensagem('Todos os dados foram limpos com sucesso!', 'success');
            
            // Atualizar displays
            document.getElementById('eventos-slots').textContent = '0/10';
            document.getElementById('feriados-slots').textContent = '0/20';
            document.getElementById('eventos-dados').style.display = 'none';
            document.getElementById('feriados-dados').style.display = 'none';
        } else {
            adicionarLog(`Erro ao limpar todos os dados: ${resultado.erro}`, 'error');
            mostrarMensagem(`Erro ao limpar todos os dados: ${resultado.erro}`, 'error');
        }
    } catch (error) {
        adicionarLog(`Erro ao limpar todos os dados: ${error.message}`, 'error');
        mostrarMensagem('Erro ao limpar todos os dados', 'error');
    }
}

// Inicializa√ß√£o da p√°gina
window.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] DOM Content Loaded - Inicializando p√°gina');
    
    // Debug - verificar se todos os elementos existem
    const elementos = [
        'connection-indicator', 'connection-text', 'connection-timestamp',
        'plenario-conexao', 'plenario-sync', 'plenario-proxima',
        'auditorio-conexao', 'auditorio-sync', 'auditorio-proxima',
        'last-sync-text', 'last-sync-timestamp', 'sync-details',
        'next-sync-text', 'auto-sync-status'
    ];
    
    console.log('[DEBUG] Verificando exist√™ncia dos elementos:');
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        console.log(`[DEBUG] ${id}: ${elemento ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO'}`);
        if (!elemento) {
            console.error(`[ERROR] Elemento ${id} n√£o encontrado no DOM!`);
        }
    });
    
    // Carregar status inicial
    console.log('[DEBUG] Carregando status inicial...');
    atualizarStatus();
    atualizarStatusAuditorio();
    
    // Atualizar status automaticamente a cada 30 segundos
    console.log('[DEBUG] Configurando atualiza√ß√£o autom√°tica a cada 30 segundos');
    setInterval(() => {
        console.log('[DEBUG] Executando atualiza√ß√£o autom√°tica...');
        atualizarStatus();
        atualizarStatusAuditorio();
    }, 30000);
});
</script>
{% endblock %}
