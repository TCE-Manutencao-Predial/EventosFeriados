{% extends "base.html" %}

{% block title %}Gerenciar Eventos - Sistema de Feriados e Eventos{% endblock %}

{% block content %}
<!-- Estatísticas por Local -->
<div class="eventos-stats">
    <div class="eventos-stat-card">
        <i class="fas fa-microphone eventos-stat-icon" style="color: var(--eventos-primary)"></i>
        <h2 class="eventos-stat-value" id="totalAuditorioNobre">0</h2>
        <p class="eventos-stat-label">Auditório Nobre</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-door-open eventos-stat-icon" style="color: var(--eventos-info)"></i>
        <h2 class="eventos-stat-value" id="totalAtrio">0</h2>
        <p class="eventos-stat-label">Átrio</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-users eventos-stat-icon" style="color: var(--eventos-warning)"></i>
        <h2 class="eventos-stat-value" id="totalPlenario">0</h2>
        <p class="eventos-stat-label">Plenário</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-baby eventos-stat-icon" style="color: var(--eventos-success)"></i>
        <h2 class="eventos-stat-value" id="totalCreche">0</h2>
        <p class="eventos-stat-label">Creche</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-door-closed eventos-stat-icon" style="color: var(--eventos-secondary)"></i>
        <h2 class="eventos-stat-value" id="totalFoyerAuditorio">0</h2>
        <p class="eventos-stat-label">Foyer do Auditório</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-chalkboard-teacher eventos-stat-icon" style="color: #6610f2"></i>
        <h2 class="eventos-stat-value" id="totalMiniAuditorio">0</h2>
        <p class="eventos-stat-label">Mini-Auditório</p>
    </div>
    <div class="eventos-stat-card">
        <i class="fas fa-handshake eventos-stat-icon" style="color: #d63384"></i>
        <h2 class="eventos-stat-value" id="totalSalaConferencias">0</h2>
        <p class="eventos-stat-label">Sala de Conferências</p>
    </div>
</div>

<!-- Controles e Filtros -->
<div class="eventos-controls">
    <div class="eventos-controls-header">
        <h3 class="eventos-controls-title"><i class="fas fa-calendar-plus"></i> Gerenciamento de Eventos</h3>
        <div class="eventos-btn-group">
            <button class="btn btn-success" onclick="abrirModalNovoEvento()">
                <i class="fas fa-plus"></i> Novo Evento
            </button>
            <button class="btn btn-primary" onclick="carregarEventos()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-building"></i> Filtrar por Local
                </label>
                <select class="form-select" id="filtroLocal" onchange="carregarEventos()">
                    <option value="">Todos os locais</option>
                    <option value="Auditório Nobre">Auditório Nobre</option>
                    <option value="Átrio">Átrio</option>
                    <option value="Plenário">Plenário</option>
                    <option value="Creche">Creche</option>
                    <option value="Foyer do Auditório">Foyer do Auditório</option>
                    <option value="Mini-Auditório">Mini-Auditório</option>
                    <option value="Sala de Conferências">Sala de Conferências</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-alt"></i> Filtrar por Mês
                </label>
                <select class="form-select" id="filtroMes" onchange="carregarEventos()">
                    <option value="">Todos os meses</option>
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar"></i> Filtrar por Ano
                </label>
                <select class="form-select" id="filtroAno" onchange="carregarEventos()">
                    <option value="">Todos os anos</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-search"></i> Buscar
                </label>
                <input type="text" class="form-control" id="buscarEvento" placeholder="Digite para buscar..." onkeyup="filtrarEventos()">
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Eventos -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="tabelaEventos">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Evento</th>
                        <th>Local</th>
                        <th>Horário</th>
                        <th>Responsável</th>
                        <th>Participantes</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="listaEventos">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo/Editar Evento -->
<div class="modal fade" id="modalEvento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEventoTitulo">Novo Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEvento">
                    <input type="hidden" id="eventoId">
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Nome do Evento*</label>
                            <input type="text" class="form-control" id="eventoNome" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Local*</label>
                            <select class="form-select" id="eventoLocal" required>
                                <option value="">Selecione...</option>
                                <option value="Auditório Nobre">Auditório Nobre</option>
                                <option value="Átrio">Átrio</option>
                                <option value="Plenário">Plenário</option>
                                <option value="Creche">Creche</option>
                                <option value="Foyer do Auditório">Foyer do Auditório</option>
                                <option value="Mini-Auditório">Mini-Auditório</option>
                                <option value="Sala de Conferências">Sala de Conferências</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Aviso para locais sem automação predial -->
                    <div class="alert alert-warning d-none" id="avisoSemAutomacao" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Atenção:</strong> Este local não possui automação predial. Os equipamentos (ar-condicionado e iluminação) deverão ser acionados manualmente. A notificação do evento será enviada via WhatsApp para os responsáveis.
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Dia*</label>
                            <input type="number" class="form-control" id="eventoDia" min="1" max="31" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Mês*</label>
                            <select class="form-select" id="eventoMes" required>
                                <option value="">Selecione...</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ano*</label>
                            <input type="number" class="form-control" id="eventoAno" min="2024" max="2030" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Hora Início*</label>
                            <input type="time" class="form-control" id="eventoHoraInicio" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hora Fim*</label>
                            <input type="time" class="form-control" id="eventoHoraFim" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Responsável</label>
                            <input type="text" class="form-control" id="eventoResponsavel">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Participantes Estimados</label>
                            <input type="number" class="form-control" id="eventoParticipantes" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="eventoDescricao" rows="3"></textarea>
                    </div>
                    
                    <!-- Aviso de Disponibilidade -->
                    <div id="avisoDisponibilidade" class="alert alert-warning d-none" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span id="mensagemDisponibilidade"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="salvarEvento()">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclusão -->
<div class="modal fade" id="modalExcluirEvento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o evento "<span id="nomeEventoExcluir"></span>"?</p>
                <p class="text-danger"><small>Esta ação não pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusaoEvento()">
                    <i class="bi bi-trash"></i> Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let eventosList = [];
let eventoExcluirId = null;

$(document).ready(function() {
    // Preencher anos no filtro
    const anoAtual = new Date().getFullYear();
    for (let ano = anoAtual - 1; ano <= anoAtual + 2; ano++) {
        $('#filtroAno').append(`<option value="${ano}">${ano}</option>`);
    }
    
    // Definir ano atual
    $('#eventoAno').val(anoAtual);
    
    // Carregar eventos
    carregarEventos();
    
    // Verificar disponibilidade ao mudar campos
    $('#eventoLocal, #eventoDia, #eventoMes, #eventoAno, #eventoHoraInicio, #eventoHoraFim').on('change', verificarDisponibilidade);
    
    // Mostrar aviso para locais sem automação predial
    $('#eventoLocal').on('change', function() {
        const local = $(this).val();
        const locaisSemAutomacao = ['Creche', 'Mini-Auditório', 'Sala de Conferências'];
        
        if (locaisSemAutomacao.includes(local)) {
            $('#avisoSemAutomacao').removeClass('d-none');
        } else {
            $('#avisoSemAutomacao').addClass('d-none');
        }
    });
});

function carregarEventos() {
    const local = $('#filtroLocal').val();
    const mes = $('#filtroMes').val();
    const ano = $('#filtroAno').val();
    
    let url = '{{ url_for("api_eventos.listar_eventos") }}';
    const params = [];
    
    if (local) params.push(`local=${encodeURIComponent(local)}`);
    if (mes) params.push(`mes=${mes}`);
    if (ano) params.push(`ano=${ano}`);
    
    // Por padrão, buscar somente eventos do ano atual quando não há filtros (local/mês/ano)
    if (!local && !mes && !ano) {
        const anoAtual = new Date().getFullYear();
        params.push(`ano_minimo=${anoAtual}`);
    }
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    $.get(url, function(data) {
        eventosList = data.eventos;
        exibirEventos();
        atualizarEstatisticas();
    }).fail(function(xhr) {
        showNotification('Erro ao carregar eventos', 'error');
    });
}

function exibirEventos() {
    const busca = $('#buscarEvento').val().toLowerCase();
    const mes = $('#filtroMes').val();
    const ano = $('#filtroAno').val();
    const local = $('#filtroLocal').val();
    const tbody = $('#listaEventos');
    tbody.empty();
    
    let eventosFiltrados = eventosList;
    
    // Regra padrão: exibir apenas hoje e futuros quando nenhum filtro (local/mês/ano ou busca) está ativo
    const filtrosAtivos = Boolean(local || mes || ano || busca);
    if (!filtrosAtivos) {
        eventosFiltrados = eventosFiltrados.filter(e => eventoDeveSerExibido(e.dia, e.mes, e.ano));
    }
    
    // Filtrar por busca
    if (busca) {
        eventosFiltrados = eventosFiltrados.filter(e => 
            e.nome.toLowerCase().includes(busca) || 
            e.local.toLowerCase().includes(busca) ||
            (e.responsavel && e.responsavel.toLowerCase().includes(busca)) ||
            (e.descricao && e.descricao.toLowerCase().includes(busca))
        );
    }
    
    if (eventosFiltrados.length === 0) {
        tbody.html('<tr><td colspan="7" class="text-center text-muted">Nenhum evento encontrado</td></tr>');
        return;
    }
    
    eventosFiltrados.forEach(function(evento) {
        const localBadge = {
            'Auditório Nobre': 'primary',
            'Átrio': 'info',
            'Plenário': 'warning',
            'Creche': 'success',
            'Foyer do Auditório': 'secondary',
            'Mini-Auditório': 'dark',
            'Sala de Conferências': 'danger'
        };
        
        // Verificar se evento foi encerrado
        const eventoEncerrado = evento.encerrado_em ? true : false;
        const classeEncerrado = eventoEncerrado ? 'table-secondary text-muted' : '';
        const estiloTextoEncerrado = eventoEncerrado ? 'style="text-decoration: line-through; opacity: 0.6;"' : '';
        
        tbody.append(`
            <tr class="${classeEncerrado}">
                <td>${evento.dia.toString().padStart(2, '0')}/${evento.mes.toString().padStart(2, '0')}/${evento.ano}</td>
                <td>
                    <strong ${estiloTextoEncerrado}>${evento.nome}</strong>
                    ${eventoEncerrado ? '<br><span class="badge bg-danger"><i class="fas fa-ban"></i> ENCERRADO</span>' : ''}
                    ${evento.descricao ? `<br><small class="text-muted">${evento.descricao}</small>` : ''}
                    ${eventoEncerrado ? `<br><small class="text-muted"><i class="fas fa-clock"></i> Encerrado em ${new Date(evento.encerrado_em).toLocaleString('pt-BR')}</small>` : ''}
                </td>
                <td><span class="badge bg-${localBadge[evento.local] || 'secondary'}">${evento.local}</span></td>
                <td ${estiloTextoEncerrado}>${evento.hora_inicio} - ${evento.hora_fim}</td>
                <td ${estiloTextoEncerrado}>${evento.responsavel || '<span class="text-muted">-</span>'}</td>
                <td ${estiloTextoEncerrado}>${evento.participantes_estimados || '<span class="text-muted">-</span>'}</td>
                <td class="text-center">
                    ${!eventoEncerrado ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="editarEvento('${evento.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluirEvento('${evento.id}', '${evento.nome}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="dispararWhatsApp('${evento.id}')" title="Disparar WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    ${eventoEhHoje(evento.dia, evento.mes, evento.ano) ? `
                    <button class="btn btn-sm btn-outline-warning" onclick="encerrarEvento('${evento.id}', '${evento.nome}', '${evento.local}')" title="Encerrar Evento Mais Cedo">
                        <i class="fas fa-stop-circle"></i>
                    </button>
                    ` : ''}
                    ` : `
                    <button class="btn btn-sm btn-outline-info" onclick="reativarEvento('${evento.id}', '${evento.nome}')" title="Reativar Evento">
                        <i class="fas fa-redo"></i> Reativar
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluirEvento('${evento.id}', '${evento.nome}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                    `}
                </td>
            </tr>
        `);
    });
}

function atualizarEstatisticas() {
    const mes = $('#filtroMes').val();
    const ano = $('#filtroAno').val();
    const local = $('#filtroLocal').val();
    const busca = $('#buscarEvento').val().toLowerCase();
    let eventosParaEstatistica = eventosList;
    
    // Aplicar a mesma regra padrão (apenas hoje/futuros) quando nenhum filtro (local/mês/ano ou busca) está ativo
    const filtrosAtivos = Boolean(local || mes || ano || busca);
    if (!filtrosAtivos) {
        eventosParaEstatistica = eventosParaEstatistica.filter(e => eventoDeveSerExibido(e.dia, e.mes, e.ano));
    }
    
    // Aplicar filtro de busca para alinhar com a tabela visível
    if (busca) {
        eventosParaEstatistica = eventosParaEstatistica.filter(e => 
            e.nome.toLowerCase().includes(busca) || 
            e.local.toLowerCase().includes(busca) ||
            (e.responsavel && e.responsavel.toLowerCase().includes(busca)) ||
            (e.descricao && e.descricao.toLowerCase().includes(busca))
        );
    }
    
    const estatisticas = {
        'Auditório Nobre': 0,
        'Átrio': 0,
        'Plenário': 0,
        'Creche': 0,
        'Foyer do Auditório': 0,
        'Mini-Auditório': 0,
        'Sala de Conferências': 0
    };
    
    eventosParaEstatistica.forEach(evento => {
        if (estatisticas.hasOwnProperty(evento.local)) {
            estatisticas[evento.local]++;
        }
    });
    
    $('#totalAuditorioNobre').text(estatisticas['Auditório Nobre']);
    $('#totalAtrio').text(estatisticas['Átrio']);
    $('#totalPlenario').text(estatisticas['Plenário']);
    $('#totalCreche').text(estatisticas['Creche']);
    $('#totalFoyerAuditorio').text(estatisticas['Foyer do Auditório']);
    $('#totalMiniAuditorio').text(estatisticas['Mini-Auditório']);
    $('#totalSalaConferencias').text(estatisticas['Sala de Conferências']);
}

function filtrarEventos() {
    exibirEventos();
}

function abrirModalNovoEvento() {
    $('#modalEventoTitulo').text('Novo Evento');
    $('#formEvento')[0].reset();
    $('#eventoId').val('');
    $('#eventoAno').val(new Date().getFullYear());
    $('#avisoDisponibilidade').addClass('d-none');
    $('#avisoSemAutomacao').addClass('d-none');
    $('#modalEvento').modal('show');
}

function editarEvento(id) {
    const evento = eventosList.find(e => e.id === id);
    if (!evento) return;
    
    $('#modalEventoTitulo').text('Editar Evento');
    $('#eventoId').val(evento.id);
    $('#eventoNome').val(evento.nome);
    $('#eventoLocal').val(evento.local);
    $('#eventoDia').val(evento.dia);
    $('#eventoMes').val(evento.mes);
    $('#eventoAno').val(evento.ano);
    $('#eventoHoraInicio').val(evento.hora_inicio);
    $('#eventoHoraFim').val(evento.hora_fim);
    $('#eventoResponsavel').val(evento.responsavel);
    $('#eventoParticipantes').val(evento.participantes_estimados);
    $('#eventoDescricao').val(evento.descricao);
    
    // Verificar se o local não possui automação predial
    const locaisSemAutomacao = ['Creche', 'Mini-Auditório', 'Sala de Conferências'];
    if (locaisSemAutomacao.includes(evento.local)) {
        $('#avisoSemAutomacao').removeClass('d-none');
    } else {
        $('#avisoSemAutomacao').addClass('d-none');
    }
    
    $('#modalEvento').modal('show');
}

function verificarDisponibilidade() {
    const local = $('#eventoLocal').val();
    const dia = $('#eventoDia').val();
    const mes = $('#eventoMes').val();
    const ano = $('#eventoAno').val();
    const horaInicio = $('#eventoHoraInicio').val();
    const horaFim = $('#eventoHoraFim').val();
    
    if (!local || !dia || !mes || !ano || !horaInicio || !horaFim) {
        return;
    }
    
    const dados = {
        local: local,
        dia: parseInt(dia),
        mes: parseInt(mes),
        ano: parseInt(ano),
        hora_inicio: horaInicio,
        hora_fim: horaFim
    };
    
    $.ajax({
        url: '{{ url_for("api_clp.verificar_disponibilidade_clp") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
            if (!response.disponivel) {
                $('#avisoDisponibilidade').removeClass('d-none');
                $('#mensagemDisponibilidade').text(response.motivo);
                
                if (response.eventos_conflitantes.length > 0) {
                    let conflitos = response.eventos_conflitantes.map(e => 
                        `${e.nome} (${e.inicio} - ${e.fim})`
                    ).join(', ');
                    $('#mensagemDisponibilidade').append(`: ${conflitos}`);
                }
            } else {
                $('#avisoDisponibilidade').addClass('d-none');
            }
        }
    });
}

function salvarEvento() {
    const id = $('#eventoId').val();
    const dados = {
        nome: $('#eventoNome').val(),
        local: $('#eventoLocal').val(),
        dia: parseInt($('#eventoDia').val()),
        mes: parseInt($('#eventoMes').val()),
        ano: parseInt($('#eventoAno').val()),
        hora_inicio: $('#eventoHoraInicio').val(),
        hora_fim: $('#eventoHoraFim').val(),
        responsavel: $('#eventoResponsavel').val(),
        participantes_estimados: parseInt($('#eventoParticipantes').val()) || 0,
        descricao: $('#eventoDescricao').val()
    };
    
    // Validar
    if (!dados.nome || !dados.local || !dados.dia || !dados.mes || !dados.ano || !dados.hora_inicio || !dados.hora_fim) {
        showNotification('Preencha todos os campos obrigatórios', 'error');
        return;
    }
    
    const url = id 
        ? `{{ url_for("api_eventos.atualizar_evento", evento_id="") }}${id}`
        : '{{ url_for("api_eventos.adicionar_evento") }}';
    
    const method = id ? 'PUT' : 'POST';
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
            $('#modalEvento').modal('hide');
            showNotification(response.mensagem || 'Evento salvo com sucesso', 'success');
            carregarEventos();
        },
        error: function(xhr) {
            const erro = xhr.responseJSON?.erro || 'Erro ao salvar evento';
            showNotification(erro, 'error');
        }
    });
}

function excluirEvento(id, nome) {
    eventoExcluirId = id;
    $('#nomeEventoExcluir').text(nome);
    $('#modalExcluirEvento').modal('show');
}

function confirmarExclusaoEvento() {
    if (!eventoExcluirId) return;
    
    $.ajax({
        url: `{{ url_for("api_eventos.remover_evento", evento_id="") }}${eventoExcluirId}`,
        method: 'DELETE',
        success: function(response) {
            $('#modalExcluirEvento').modal('hide');
            showNotification('Evento excluído com sucesso', 'success');
            carregarEventos();
        },
        error: function(xhr) {
            showNotification('Erro ao excluir evento', 'error');
        }
    });
}

function dispararWhatsApp(eventoId, tipo = 'detalhes') {
    if (!eventoId) return;
    if (!confirm('Deseja disparar a notificação de WhatsApp agora?')) return;
    $.ajax({
        url: `/api/eventos/${eventoId}/forcar-notificacao-whatsapp?tipo=${encodeURIComponent(tipo)}`,
        method: 'POST',
        success: function(resp) {
            showNotification('Notificação WhatsApp disparada com sucesso', 'success');
        },
        error: function(xhr) {
            const msg = (xhr.responseJSON && xhr.responseJSON.erro) ? xhr.responseJSON.erro : 'Falha ao disparar WhatsApp';
            showNotification(msg, 'error');
        }
    });
}

function eventoEhHoje(dia, mes, ano) {
    const hoje = new Date();
    return dia === hoje.getDate() && mes === (hoje.getMonth() + 1) && ano === hoje.getFullYear();
}

function encerrarEvento(eventoId, nomeEvento, local) {
    if (!eventoId) return;
    
    const mensagem = `Deseja realmente ENCERRAR o evento "${nomeEvento}" AGORA?\n\n` +
                    `Esta ação irá:\n` +
                    `• Remover o evento de hoje do CLP\n` +
                    `• Desligar as luzes e ar condicionado do ${local}\n` +
                    `• O evento será encerrado IMEDIATAMENTE\n\n` +
                    `Você poderá REATIVAR o evento depois se necessário.`;
    
    if (!confirm(mensagem)) return;
    
    // Mostrar indicador de carregamento
    const btnElement = event.target.closest('button');
    const originalHTML = btnElement.innerHTML;
    btnElement.disabled = true;
    btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    $.ajax({
        url: `/api/eventos/${eventoId}/encerrar`,
        method: 'POST',
        success: function(resp) {
            if (resp.sem_automacao) {
                showNotification(resp.mensagem, 'warning');
            } else {
                showNotification(resp.mensagem || 'Evento encerrado com sucesso!', 'success');
            }
            // Recarregar eventos após 2 segundos
            setTimeout(() => {
                carregarEventos();
            }, 2000);
        },
        error: function(xhr) {
            const msg = (xhr.responseJSON && xhr.responseJSON.erro) 
                ? xhr.responseJSON.erro 
                : 'Falha ao encerrar evento';
            showNotification(msg, 'error');
            
            // Restaurar botão
            btnElement.disabled = false;
            btnElement.innerHTML = originalHTML;
        },
        complete: function() {
            // Restaurar botão caso ainda não tenha sido restaurado
            setTimeout(() => {
                btnElement.disabled = false;
                btnElement.innerHTML = originalHTML;
            }, 100);
        }
    });
}

function reativarEvento(eventoId, nomeEvento) {
    if (!eventoId) return;
    
    const mensagem = `Deseja realmente REATIVAR o evento "${nomeEvento}"?\n\n` +
                    `Esta ação irá:\n` +
                    `• Remover a marca de encerramento\n` +
                    `• Reprogramar o evento no CLP na próxima sincronização\n` +
                    `• Reativar iluminação e ar condicionado conforme programação original`;
    
    if (!confirm(mensagem)) return;
    
    // Mostrar indicador de carregamento
    const btnElement = event.target.closest('button');
    const originalHTML = btnElement.innerHTML;
    btnElement.disabled = true;
    btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    $.ajax({
        url: `/api/eventos/${eventoId}/reativar`,
        method: 'POST',
        success: function(resp) {
            showNotification(resp.mensagem || 'Evento reativado com sucesso!', 'success');
            // Recarregar eventos após 1 segundo
            setTimeout(() => {
                carregarEventos();
            }, 1000);
        },
        error: function(xhr) {
            const msg = (xhr.responseJSON && xhr.responseJSON.erro) 
                ? xhr.responseJSON.erro 
                : 'Falha ao reativar evento';
            showNotification(msg, 'error');
            
            // Restaurar botão
            btnElement.disabled = false;
            btnElement.innerHTML = originalHTML;
        },
        complete: function() {
            // Restaurar botão caso ainda não tenha sido restaurado
            setTimeout(() => {
                btnElement.disabled = false;
                btnElement.innerHTML = originalHTML;
            }, 100);
        }
    });
}
</script>
{% endblock %}